<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" href="/media/logo.png">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-7088638806330528",
      enable_page_level_ads: true
    });
  </script>

  <!-- Hotjar Tracking Code for variora.ml -->
  <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:932030,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>

  {% include "home/tools_import_subpage.html" %}
  <title>Variora</title>
</head>
<body>
    <div id="main"></div>
</body>

{% if DEBUG %}
  <script src="/static/bundle/home/test_index.js"></script>
{% else %}
  <script src="/static/bundle/home/test_index.js"></script>
{% endif %}

<!-- Firebase -->
<!-- START INITIALIZATION CODE -->
<script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBZGwBGXiTOjct__VUXlONOLhEhbwGNY2w",
    authDomain: "variora-messaging.firebaseapp.com",
    databaseURL: "https://variora-messaging.firebaseio.com",
    projectId: "variora-messaging",
    storageBucket: "variora-messaging.appspot.com",
    messagingSenderId: "241959101179"
  };
  firebase.initializeApp(config);
</script><!-- END INITIALIZATION CODE -->
<!-- ******************************************************** -->
<script>
  // this is the helper function for getting csrf_token
  function getCookie(name) {
    var cookieValue = null
    if (document.cookie && document.cookie != '') {
      var cookies = document.cookie.split(';')
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim()
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) == (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
          break
        }
      }
    }
    return cookieValue
  }

  const messaging = firebase.messaging();
  navigator.serviceWorker.register('./firebase-messaging-sw.js')
  .then((registration) => {
    messaging.useServiceWorker(registration);
    // only do this if user is authenticated.
    messaging.requestPermission()
    .then(() => {
      console.log('Notification permission granted.');
      return messaging.getToken()
    })  
    .then(token => {
      console.log("FCM Token:", token);
      console.log(getCookie('csrftoken'))
      fetch('http://localhost:8000/devices', {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
        body: JSON.stringify({
          'registration_id': token,
          'type': 'web',
        }),
        credentials: "include",
      }).then(function(response) {
        console.log(response);
        return response.json();
      }).then(json => console.log(json))
    })
  })
  .catch(error => {
    if (error.code === "messaging/permission-blocked") {
      console.log("Please Unblock Notification Request Manually");
    } else {
      console.log("Error Occurred", error);
    }
  });

  // called when app has focus
  messaging.onMessage(function(payload) {
    console.log("Message received. ", payload);
    // Can update UI to reflect message
    
  });

</script>
<!-- Firebase End -->

</html>
